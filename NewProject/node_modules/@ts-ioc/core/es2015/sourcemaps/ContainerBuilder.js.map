{"version":3,"sources":["ContainerBuilder.ts"],"names":[],"mappings":"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","file":"../ContainerBuilder.js","sourcesContent":["import { IContainer } from './IContainer';\r\nimport { Container } from './Container';\r\nimport { Type, Modules, LoadType, Express } from './types';\r\nimport { IContainerBuilder, ContainerBuilderToken } from './IContainerBuilder';\r\nimport {\r\n    IModuleLoader, ModuleLoaderToken, DefaultModuleLoader, IModuleInjectorChain,\r\n    ModuleInjectorChainToken, IocExtModuleValidateToken, ModuleInjector, IocExtModuleValidate,\r\n    ModuleInjectorChain, ModuelValidate, ModuleValidateToken, ModuleInjectorToken\r\n} from './injectors';\r\nimport { PromiseUtil } from './utils';\r\n\r\n/**\r\n * default container builder.\r\n *\r\n * @export\r\n * @class DefaultContainerBuilder\r\n * @implements {IContainerBuilder}\r\n */\r\nexport class ContainerBuilder implements IContainerBuilder {\r\n\r\n    private _loader: IModuleLoader;\r\n    filter: Express<Type<any>, boolean>;\r\n    constructor(loader?: IModuleLoader) {\r\n        this._loader = loader;\r\n    }\r\n\r\n    get loader(): IModuleLoader {\r\n        if (!this._loader) {\r\n            this._loader = new DefaultModuleLoader();\r\n        }\r\n\r\n        return this._loader;\r\n    }\r\n\r\n    create(): IContainer {\r\n        let container = new Container();\r\n        container.bindProvider(ContainerBuilderToken, () => this);\r\n        container.bindProvider(ModuleLoaderToken, () => this.loader);\r\n        return container;\r\n    }\r\n\r\n    /**\r\n     * build container.\r\n     *\r\n     * @param {...LoadType[]} [modules]\r\n     * @returns\r\n     * @memberof DefaultContainerBuilder\r\n     */\r\n    async build(...modules: LoadType[]) {\r\n        let container: IContainer = this.create();\r\n        if (modules.length) {\r\n            await this.loadModule(container, ...modules);\r\n        }\r\n        return container;\r\n    }\r\n\r\n    /**\r\n     * load modules for container.\r\n     *\r\n     * @param {IContainer} container\r\n     * @param {...LoadType[]} modules\r\n     * @returns {Promise<Type<any>[]>}\r\n     * @memberof DefaultContainerBuilder\r\n     */\r\n    async loadModule(container: IContainer, ...modules: LoadType[]): Promise<Type<any>[]> {\r\n        let regModules = await this.loader.loadTypes(modules);\r\n        let injTypes = [];\r\n        if (regModules && regModules.length) {\r\n            let injChain = this.getInjectorChain(container);\r\n            await PromiseUtil.step(regModules.map(typs => async () => {\r\n                let ityps = await injChain.inject(container, typs);\r\n                injTypes = injTypes.concat(ityps);\r\n            }));\r\n        }\r\n        return injTypes;\r\n    }\r\n\r\n\r\n    syncBuild(...modules: Modules[]): IContainer {\r\n        let container: IContainer = this.create();\r\n        if (modules.length) {\r\n            this.syncLoadModule(container, ...modules);\r\n        }\r\n        return container;\r\n    }\r\n\r\n    syncLoadModule(container: IContainer, ...modules: Modules[]): Type<any>[] {\r\n        let regModules = this.loader.getTypes(modules);\r\n        let injTypes: Type<any>[] = [];\r\n        if (regModules && regModules.length) {\r\n            let injChain = this.getInjectorChain(container);\r\n            regModules.forEach(typs => {\r\n                let ityps = injChain.syncInject(container, typs);\r\n                injTypes = injTypes.concat(ityps);\r\n            });\r\n        }\r\n        return injTypes;\r\n    }\r\n\r\n    getInjectorChain(container: IContainer): IModuleInjectorChain {\r\n        if (!container.has(ModuleInjectorChainToken)) {\r\n            container.register(ModuleInjector)\r\n                .bindProvider(ModuleValidateToken, new ModuelValidate())\r\n                .bindProvider(IocExtModuleValidateToken, new IocExtModuleValidate())\r\n                .bindProvider(ModuleInjectorChainToken,\r\n                    new ModuleInjectorChain()\r\n                        .next(container.resolve(ModuleInjectorToken, { provide: ModuleValidateToken, useValue: container.get(IocExtModuleValidateToken) }, { skipNext: true }))\r\n                        .next(container.resolve(ModuleInjectorToken))\r\n                );\r\n        }\r\n        return container.get(ModuleInjectorChainToken);\r\n    }\r\n\n                        static getClassAnnations():any  {\n                            return {\"name\":\"ContainerBuilder\",\"params\":{\"constructor\":[\"loader\"],\"create\":[],\"build\":[\"modules\"],\"loadModule\":[\"container\",\"modules\"],\"syncBuild\":[\"modules\"],\"syncLoadModule\":[\"container\",\"modules\"],\"getInjectorChain\":[\"container\"]}};\n                        }\n                   }\r\n"]}