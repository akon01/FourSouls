{"version":3,"sources":["core/MethodAccessor.ts"],"names":[],"mappings":"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","file":"../../core/MethodAccessor.js","sourcesContent":["import { IContainer } from '../IContainer';\r\nimport { IMethodAccessor } from '../IMethodAccessor';\r\nimport { BindParameterProviderActionData, CoreActions, LifeState } from './actions';\r\nimport { isToken, isFunction, lang, isNullOrUndefined } from '../utils';\r\nimport { Type } from '../types';\r\nimport { IParameter } from '../IParameter';\r\nimport { ParamProviders, isProvider } from '../providers';\r\n\r\n/**\r\n * method accessor\r\n *\r\n * @export\r\n * @class MethodAccessor\r\n * @implements {IMethodAccessor}\r\n */\r\nexport class MethodAccessor implements IMethodAccessor {\r\n\r\n    constructor(private container: IContainer) {\r\n\r\n    }\r\n\r\n    async invoke<T>(target: any, propertyKey: string, instance?: any, ...providers: ParamProviders[]): Promise<T> {\r\n\r\n        let targetClass: Type<any>;\r\n        if (isProvider(instance)) {\r\n            providers.unshift(instance);\r\n            instance = undefined;\r\n        }\r\n        if (isToken(target)) {\r\n            if (isNullOrUndefined(instance)) {\r\n                targetClass = this.container.getTokenImpl(target);\r\n                instance = this.container.resolve(target, ...providers);\r\n            } else {\r\n                targetClass = lang.getClass(instance) || this.container.getTokenImpl(target);\r\n            }\r\n            lang.assert(targetClass, target.toString() + ' is not implements by any class.');\r\n        } else {\r\n            targetClass = lang.getClass(target);\r\n            instance = target;\r\n        }\r\n\r\n        lang.assertExp(instance && isFunction(instance[propertyKey]), `type: ${targetClass} has no method ${propertyKey.toString()}.`);\r\n        let actionData = {\r\n            target: instance,\r\n            targetType: targetClass,\r\n            propertyKey: propertyKey,\r\n        } as BindParameterProviderActionData;\r\n        let lifeScope = this.container.getLifeScope();\r\n        lifeScope.execute(actionData, LifeState.onInit, CoreActions.bindParameterProviders);\r\n        providers = providers.concat(actionData.execResult);\r\n\r\n        let parameters = lifeScope.getMethodParameters(targetClass, instance, propertyKey);\r\n\r\n        let paramInstances = await this.createParams(parameters, ...providers);\r\n\r\n        return instance[propertyKey](...paramInstances) as T;\r\n\r\n    }\r\n\r\n    syncInvoke<T>(target: any, propertyKey: string, instance?: any, ...providers: ParamProviders[]): T {\r\n        let targetClass: Type<any>;\r\n        if (isProvider(instance)) {\r\n            providers.unshift(instance);\r\n            instance = undefined;\r\n        }\r\n        if (isToken(target)) {\r\n            targetClass = this.container.getTokenImpl(target);\r\n            lang.assert(targetClass, target.toString() + ' is not implements by any class.');\r\n            if (isNullOrUndefined(instance)) {\r\n                instance = this.container.resolve(target, ...providers);\r\n            }\r\n        } else {\r\n            targetClass = lang.getClass(target);\r\n            instance = target;\r\n        }\r\n        lang.assertExp(instance && isFunction(instance[propertyKey]), `type: ${targetClass} has no method ${propertyKey.toString()}.`);\r\n\r\n        let actionData = {\r\n            target: instance,\r\n            targetType: targetClass,\r\n            propertyKey: propertyKey,\r\n        } as BindParameterProviderActionData;\r\n        let lifeScope = this.container.getLifeScope();\r\n        lifeScope.execute(actionData, LifeState.onInit, CoreActions.bindParameterProviders);\r\n\r\n        providers = providers.concat(actionData.execResult);\r\n        let parameters = lifeScope.getMethodParameters(targetClass, instance, propertyKey);\r\n        let paramInstances = this.createSyncParams(parameters, ...providers);\r\n\r\n        return instance[propertyKey](...paramInstances) as T;\r\n    }\r\n\r\n    createSyncParams(params: IParameter[], ...providers: ParamProviders[]): any[] {\r\n        let providerMap = this.container.getProviderParser().parse(...providers);\r\n        return params.map((param, index) => {\r\n            if (param.name && providerMap.has(param.name)) {\r\n                return providerMap.resolve(param.name);\r\n            } else if (isToken(param.type)) {\r\n                if (providerMap.has(param.type)) {\r\n                    return providerMap.resolve(param.type);\r\n                }\r\n                return this.container.resolve(param.type, providerMap);\r\n            } else {\r\n                return undefined;\r\n            }\r\n        });\r\n    }\r\n\r\n    createParams(params: IParameter[], ...providers: ParamProviders[]): Promise<any[]> {\r\n        let providerMap = this.container.getProviderParser().parse(...providers);\r\n        return Promise.all(params.map((param, index) => {\r\n            if (param.name && providerMap.has(param.name)) {\r\n                return providerMap.resolve(param.name);\r\n            } else if (isToken(param.type)) {\r\n                if (providerMap.has(param.type)) {\r\n                    return providerMap.resolve(param.type);\r\n                }\r\n                return this.container.resolve(param.type, providerMap);\r\n            } else {\r\n                return undefined;\r\n            }\r\n        }));\r\n    }\r\n\n                        static getClassAnnations():any  {\n                            return {\"name\":\"MethodAccessor\",\"params\":{\"constructor\":[\"container\"],\"invoke\":[\"target\",\"propertyKey\",\"instance\",\"providers\"],\"syncInvoke\":[\"target\",\"propertyKey\",\"instance\",\"providers\"],\"createSyncParams\":[\"params\",\"providers\"],\"createParams\":[\"params\",\"providers\"]}};\n                        }\n                   }\r\n"]}