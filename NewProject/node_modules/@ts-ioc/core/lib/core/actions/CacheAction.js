"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var ActionComposite_1 = require("./ActionComposite");
var utils_1 = require("../../utils");
var CoreActions_1 = require("./CoreActions");
var factories_1 = require("../factories");
var ICacheManager_1 = require("../../ICacheManager");
/**
 * cache action. To cache instance of Token. define cache expires in decorator.
 *
 * @export
 * @class CacheAction
 * @extends {ActionComposite}
 */
var CacheAction = /** @class */ (function (_super) {
    tslib_1.__extends(CacheAction, _super);
    function CacheAction() {
        return _super.call(this, CoreActions_1.CoreActions.cache) || this;
    }
    CacheAction.prototype.working = function (container, data) {
        if (data.raiseContainer && data.raiseContainer !== container) {
            return data;
        }
        if (data.singleton || !data.targetType || !utils_1.isClass(data.targetType)) {
            return data;
        }
        var cacheManager = container.get(ICacheManager_1.CacheManagerToken);
        if (data.target) {
            if (!cacheManager.hasCache(data.targetType)) {
                var cacheMetadata = this.getCacheMetadata(container, data);
                if (cacheMetadata) {
                    cacheManager.cache(data.targetType, data.target, cacheMetadata.expires);
                }
            }
        }
        else {
            var target = cacheManager.get(data.targetType);
            if (target) {
                var cacheMetadata = this.getCacheMetadata(container, data);
                if (cacheMetadata) {
                    cacheManager.cache(data.targetType, target, cacheMetadata.expires);
                    data.execResult = target;
                }
            }
        }
        return data;
    };
    CacheAction.prototype.getCacheMetadata = function (container, data) {
        var lifeScope = container.getLifeScope();
        var matchs = lifeScope.getClassDecorators(data.targetType);
        var cacheMetadata;
        for (var i = 0; i < matchs.length; i++) {
            var surm = matchs[i];
            var metadata = factories_1.getOwnTypeMetadata(surm.name, data.targetType);
            if (Array.isArray(metadata) && metadata.length > 0) {
                cacheMetadata = metadata.find(function (c) { return c && utils_1.isNumber(c.expires) && c.expires > 0; });
                if (cacheMetadata) {
                    break;
                }
            }
        }
        return cacheMetadata;
    };
    CacheAction.getClassAnnations = function () {
        return { "name": "CacheAction", "params": { "constructor": [], "working": ["container", "data"], "getCacheMetadata": ["container", "data"] } };
    };
    return CacheAction;
}(ActionComposite_1.ActionComposite));
exports.CacheAction = CacheAction;

//# sourceMappingURL=../../sourcemaps/core/actions/CacheAction.js.map
